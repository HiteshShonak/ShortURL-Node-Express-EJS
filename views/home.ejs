<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShortURL | Home</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/?size=100&id=rLMbY01ZXrPE&format=png&color=000000">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <meta name="view-transition" content="same-origin">
    
    <!-- Common Styles (shared across all pages) -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/navbar.css">
    
    <!-- Page-specific Styles -->
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>

    <!-- Include Navbar Partial -->
    <%- include('partials/navbar', { page: 'home' }) %>

    <div class="container">

        <!-- URL Shortener Card -->
        <div class="card">
            <% if (locals.id) { %>
                <div class="result-box">
                    <div class="result-content">
                        <span class="label-text">ðŸš€ Generated:</span>
                        <a href="http://localhost:10000/url/<%= id %>" target="_blank" class="link" id="generatedUrl">
                            http://localhost:10000/url/<%= id %>
                        </a>
                    </div>

                    <div class="result-actions">
                        <span id="copyMessage" class="copy-feedback">Copied!</span>

                        <button class="btn-icon" onclick="copyResult()" title="Copy to Clipboard">
                            <i class="ph ph-copy"></i>
                        </button>

                        <button class="btn-icon" onclick="openShareModal('<%= id %>')" title="Share">
                            <i class="ph ph-share-network"></i>
                        </button> 
                        
                        <a href="/" class="btn-icon btn-close" title="Clear">
                            <i class="ph ph-x"></i>
                        </a>
                    </div>
                </div>
            <% } %>

            <form method="POST" action="/url">
                <div class="form-group">
                    <input type="text" name="url" placeholder="Paste your long link here..." required>
                    <button type="submit" class="shorten-btn">Shorten It</button>
                </div>
            </form>
        </div>

        <!-- Recent Links Table -->
        <% if (locals.urls && locals.urls.length > 0) { %>
            <div class="card">
                <h3><%= locals.user && locals.user.role === 'ADMIN' ? 'All System Links' : 'Your Recent Links' %></h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Original URL</th>
                                <th>Short Link</th>
                                
                                <% if (locals.user && locals.user.role === 'ADMIN') { %>
                                    <th>Created By</th>
                                <% } %>

                                <th style="text-align: center;">Share</th>
                                <th style="text-align: center;">Analytics</th>
                                <th style="text-align: center;">Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% urls.forEach(url => { %>
                                <tr>
                                    <td data-label="Original URL">
                                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            <%= url.redirectUrl %>
                                        </div>
                                    </td>

                                    <td data-label="Short Link">
                                        <a href="http://localhost:10000/url/<%= url.shortId %>" target="_blank" style="font-weight: 600;">
                                            <%= url.shortId %>
                                        </a>
                                    </td>

                                    <% if (locals.user && locals.user.role === 'ADMIN') { %>
                                        <td data-label="Created By">
                                            <div style="display: flex; flex-direction: column; line-height: 1.3;">
                                                <% if (url.createdBy) { %>
                                                    <span style="font-weight: 600; font-size: 0.9rem; color: #111;">
                                                        <%= url.createdBy.name %>
                                                    </span>
                                                    <span style="font-size: 0.75rem; color: #666;">
                                                        <%= url.createdBy.email %>
                                                    </span>
                                                <% } else { %>
                                                    <span style="color: #999;">Unknown</span>
                                                <% } %>
                                            </div>
                                        </td>
                                    <% } %>

                                    <td data-label="Share" style="text-align: center;">
                                        <button class="btn-icon" onclick="openShareModal('<%= url.shortId %>')" style="color: #4f46e5; background: #eef2ff;">
                                            <i class="ph ph-share-network"></i>
                                        </button>
                                    </td>

                                    <td data-label="Analytics" style="text-align: center;">
                                        <a href="/url/analytics/<%= url.shortId %>" class="analytics-link">
                                            ðŸ“Š Stats
                                        </a>
                                    </td>

                                    <td data-label="Delete" style="text-align: center;">
                                        <button class="btn-icon" style="color: #ef4444;" title="Delete" onclick="openDeleteModal('<%= url.shortId %>')">
                                            Ã—
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>

    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="share-overlay" onclick="closeShareModal(event)">
        <div class="share-modal">
            <button class="modal-close" onclick="closeShareModal(null, true)">Ã—</button>
            <div class="modal-title">Share Link</div>
            <div class="modal-desc">Trackable links created automatically.</div>
            
            <div class="share-grid">
                <div class="share-option" onclick="shareTo('whatsapp')">
                    <i class="ph ph-whatsapp-logo icon-wa"></i>
                    <span>WhatsApp</span>
                </div>
                
                <div class="share-option" onclick="shareTo('telegram')">
                    <i class="ph ph-telegram-logo icon-tg"></i>
                    <span>Telegram</span>
                </div>

                <div class="share-option" onclick="shareTo('linkedin')">
                    <i class="ph ph-linkedin-logo icon-li"></i>
                    <span>LinkedIn</span>
                </div>

                <div class="share-option" onclick="shareTo('instagram')">
                    <i class="ph ph-instagram-logo icon-ig"></i>
                    <span>Instagram</span>
                </div>

                <div class="share-option" onclick="shareTo('copy')" style="grid-column: span 2;">
                    <i class="ph ph-copy icon-cp"></i>
                    <span>Copy Link</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="share-overlay" onclick="closeDeleteModal(event)">
        <div class="share-modal">
            <button class="modal-close" onclick="closeDeleteModal(null, true)">Ã—</button>
            
            <div style="font-size: 2.5rem; color: #ef4444; margin-bottom: 10px;">
                <i class="ph ph-warning-circle"></i>
            </div>
            
            <div class="modal-title">Delete Link?</div>
            <div class="modal-desc">This action cannot be undone.</div>
            
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeDeleteModal(null, true)">Cancel</button>
                <button class="btn-modal btn-confirm" onclick="confirmDelete()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/home-modals.js"></script>

    <script>
        function copyResult() {
            const url = document.getElementById('generatedUrl').href;
            const msg = document.getElementById('copyMessage');
            
            navigator.clipboard.writeText(url).then(() => {
                msg.style.display = 'block';
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
    </script>

</body>
</html>
